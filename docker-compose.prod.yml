# ============================================
# 生产环境 Docker Compose 配置
# ============================================
# 使用 GHCR 镜像 + Watchtower 自动更新
# 与已有的 postgres/redis 服务集成
# ============================================

services:
  # ----------------------------------------------------------------
  # 1. Backend 服务 (使用 GHCR 镜像)
  # ----------------------------------------------------------------
  backend:
    image: ghcr.io/love-gwen2025/my-agent/backend:latest
    container_name: my-agent-backend
    restart: always
    ports:
      - "127.0.0.1:8081:8080"
    environment:
      # ==================== 应用基础 ====================
      - APP_ENV=prod
      - APP_NAME=my-agent-py
      - APP_LOG_LEVEL=warning

      # ==================== PostgreSQL 数据库 ====================
      - DB_HOST=pg_vector
      - DB_PORT=5432
      - DB_NAME=my_agent
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-123456}
      - DB_POOL_SIZE=10
      - DB_MAX_OVERFLOW=10

      # ==================== Redis 缓存 ====================
      - REDIS_HOST=redis_cache
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-123456}
      - REDIS_DB=0

      # ==================== JWT 认证 ====================
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - JWT_EXPIRE_MINUTES=60
      - JWT_ISSUER=${JWT_ISSUER:-my-agent}

      # ==================== AI 提供商选择 ====================
      - AI_PROVIDER=${AI_PROVIDER:-deepseek}

      # ==================== DeepSeek 配置 ====================
      - AI_DEEPSEEK_API_KEY=${AI_DEEPSEEK_API_KEY}
      - AI_DEEPSEEK_BASE_URL=${AI_DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      - AI_DEEPSEEK_MODEL_NAME=${AI_DEEPSEEK_MODEL_NAME:-deepseek-chat}
      - AI_DEEPSEEK_TEMPERATURE=${AI_DEEPSEEK_TEMPERATURE:-0.7}
      - AI_DEEPSEEK_TIMEOUT=${AI_DEEPSEEK_TIMEOUT:-30}

      # ==================== OpenAI 配置 ====================
      - AI_OPENAI_API_KEY=${AI_OPENAI_API_KEY:-}
      - AI_OPENAI_BASE_URL=${AI_OPENAI_BASE_URL:-https://api.openai.com/v1}

      # ==================== Gemini 配置 ====================
      - AI_GEMINI_API_KEY=${AI_GEMINI_API_KEY:-}
      - AI_GEMINI_MODEL_NAME=${AI_GEMINI_MODEL_NAME:-gemini-2.0-flash}
      - AI_GEMINI_TEMPERATURE=${AI_GEMINI_TEMPERATURE:-0.7}

      # ==================== 自定义中转站 ====================
      - AI_CUSTOM_API_KEY=${AI_CUSTOM_API_KEY:-}
      - AI_CUSTOM_BASE_URL=${AI_CUSTOM_BASE_URL:-}
      - AI_CUSTOM_MODEL_NAME=${AI_CUSTOM_MODEL_NAME:-gpt-4}
      - AI_CUSTOM_TEMPERATURE=${AI_CUSTOM_TEMPERATURE:-0.7}
      - AI_CUSTOM_TIMEOUT=${AI_CUSTOM_TIMEOUT:-60}

      # ==================== Embedding 向量化 ====================
      - AI_EMBEDDING_PROVIDER=${AI_EMBEDDING_PROVIDER:-local}
      - AI_EMBEDDING_MODEL=${AI_EMBEDDING_MODEL:-BAAI/bge-small-zh-v1.5}
      - AI_EMBEDDING_DIMENSION=${AI_EMBEDDING_DIMENSION:-512}
      - AI_EMBEDDING_API_KEY=${AI_EMBEDDING_API_KEY:-}
      - AI_EMBEDDING_BASE_URL=${AI_EMBEDDING_BASE_URL:-}

      # ==================== 对话上下文 & RAG ====================
      - CONVERSATION_CACHE_TTL=${CONVERSATION_CACHE_TTL:-3600}
      - CONVERSATION_CACHE_MAX_MESSAGES=${CONVERSATION_CACHE_MAX_MESSAGES:-20}
      - MAX_HISTORY_MESSAGES=${MAX_HISTORY_MESSAGES:-20}
      - MAX_HISTORY_TOKENS=${MAX_HISTORY_TOKENS:-4000}
      - RAG_ENABLED=${RAG_ENABLED:-true}
      - RAG_TOP_K=${RAG_TOP_K:-5}
      - RAG_SIMILARITY_THRESHOLD=${RAG_SIMILARITY_THRESHOLD:-0.6}

      # ==================== Tavily 搜索 ====================
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - TAVILY_ENABLED=${TAVILY_ENABLED:-true}

      # ==================== OSS 对象存储 ====================
      - OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
      - OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
      - OSS_BUCKET=${OSS_BUCKET:-}
      - OSS_REGION=${OSS_REGION:-cn-hangzhou}
      - OSS_ENDPOINT=${OSS_ENDPOINT:-}
      - OSS_CUSTOM_DOMAIN=${OSS_CUSTOM_DOMAIN:-}
      - OSS_OBJECT_PREFIX=${OSS_OBJECT_PREFIX:-}
      - OSS_AVATAR=${OSS_AVATAR:-}

      # ==================== 功能开关 ====================
      - ENABLE_SSE_STREAMING=true
      - ENABLE_WEBSOCKET=true
    labels:
      # Watchtower 标签 - 启用自动更新
      - "com.centurylinklabs.watchtower.enable=true"
    # 注意: postgres 和 redis 是外部服务 (1panel-network)，不在此文件中定义
    networks:
      - 1panel-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ----------------------------------------------------------------
  # 2. Frontend 服务 (使用 GHCR 镜像)
  # ----------------------------------------------------------------
  my-agent-frontend:
    image: ghcr.io/love-gwen2025/my-agent/frontend:latest
    container_name: my-agent-frontend
    restart: always
    ports:
      - "127.0.0.1:3001:80"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      - backend
    networks:
      - 1panel-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ----------------------------------------------------------------
  # 3. Watchtower - 自动更新容器
  # ----------------------------------------------------------------
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    environment:
      # 每 5 分钟检查一次更新 (300秒)
      - WATCHTOWER_POLL_INTERVAL=300
      # 只更新有 watchtower.enable=true 标签的容器
      - WATCHTOWER_LABEL_ENABLE=true
      # 更新后清理旧镜像
      - WATCHTOWER_CLEANUP=true
      # 发送通知 (可选: 配置 Slack/Telegram 等)
      # - WATCHTOWER_NOTIFICATIONS=slack
      # - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=https://hooks.slack.com/...
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # GHCR 认证配置 (如果是 private 仓库需要)
      - ~/.docker/config.json:/config.json:ro
    command: --interval 300
    networks:
      - 1panel-network

networks:
  1panel-network:
    external: true
